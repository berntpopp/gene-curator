---
phase: 02-tab-structure
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - frontend/src/components/dynamic/DynamicForm.vue
  - frontend/src/components/dynamic/__tests__/DynamicForm.tabs.spec.js
  - frontend/src/components/dynamic/__tests__/TabContent.spec.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Tab headers show icons when configured in schema"
    - "Tab headers show score badges when tab.show_score_badge is true"
    - "Score badges update reactively as formData changes"
    - "Mobile swipe gestures navigate between tabs"
    - "Tests verify tab rendering, section collapsibility, and fallback behavior"
  artifacts:
    - path: "frontend/src/components/dynamic/DynamicForm.vue"
      provides: "Score badges on tab headers, mobile swipe support"
      contains: ["v-chip", "tabScores computed", "getScoreColor", ":touch"]
    - path: "frontend/src/components/dynamic/__tests__/DynamicForm.tabs.spec.js"
      provides: "Tab rendering tests including fallback and validation"
      min_lines: 100
    - path: "frontend/src/components/dynamic/__tests__/TabContent.spec.js"
      provides: "TabContent section rendering tests"
      min_lines: 80
  key_links:
    - from: "DynamicForm.vue tabScores computed"
      to: "validationResult.score_calculations"
      via: "computed property mapping tab IDs to scores"
      pattern: "tabScores.*computed"
    - from: "DynamicForm.tabs.spec.js"
      to: "DynamicForm.vue"
      via: "mount with mock schema containing ui_configuration"
      pattern: "mount.*DynamicForm"
---

<objective>
Add score badge display to tabs and comprehensive test coverage for tab structure.

Purpose: Complete the tab UI with live score feedback and ensure reliability through tests covering tab rendering, section collapsibility, field path resolution, and backward compatibility fallback.

Output: DynamicForm.vue with score badges and mobile support, test files proving tab/section behavior works correctly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-tab-structure/02-CONTEXT.md
@.planning/phases/02-tab-structure/02-RESEARCH.md
@.planning/phases/02-tab-structure/02-01-SUMMARY.md
@frontend/src/components/dynamic/DynamicForm.vue
@frontend/src/components/dynamic/TabContent.vue
@frontend/src/components/dynamic/__tests__/DynamicField.spec.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Score Badges and Mobile Support</name>
  <files>frontend/src/components/dynamic/DynamicForm.vue</files>
  <action>
Enhance DynamicForm.vue tabs with score badges and mobile swipe navigation:

1. **Add tabScores computed property:**
   ```javascript
   const tabScores = computed(() => {
     if (!validationResult.value?.score_calculations) return {}

     const scores = {}
     validTabs.value.forEach(tab => {
       if (tab.show_score_badge) {
         scores[tab.id] = calculateTabScore(tab)
       }
     })

     return scores
   })
   ```

2. **Add calculateTabScore function:**
   - Map tab.id to score_calculations fields based on convention:
     - `genetic` tab -> `score_calculations.genetic_evidence_score`
     - `experimental` tab -> `score_calculations.experimental_evidence_score`
     - Other tabs -> check for `score_calculations[tab.id + '_score']`
   - Return null if no matching score found

3. **Add getScoreColor function:**
   ```javascript
   function getScoreColor(score) {
     if (score === null || score === undefined) return 'grey'
     if (score >= 7) return 'success'
     if (score >= 2) return 'warning'
     return 'info'
   }
   ```

4. **Update v-tab template to include score badge:**
   ```vue
   <v-tab v-for="tab in validTabs" :key="tab.id" :value="tab.id">
     <v-icon v-if="tab.icon" :icon="tab.icon" start />
     {{ tab.name }}
     <v-chip
       v-if="tab.show_score_badge && tabScores[tab.id] !== undefined"
       :color="getScoreColor(tabScores[tab.id])"
       size="small"
       variant="flat"
       class="ml-2"
     >
       {{ tabScores[tab.id] }}
     </v-chip>
   </v-tab>
   ```

5. **Add mobile swipe support to v-window:**
   ```javascript
   // Add swipe navigation functions
   function nextTab() {
     const currentIndex = validTabs.value.findIndex(t => t.id === activeTab.value)
     if (currentIndex < validTabs.value.length - 1) {
       activeTab.value = validTabs.value[currentIndex + 1].id
     }
   }

   function prevTab() {
     const currentIndex = validTabs.value.findIndex(t => t.id === activeTab.value)
     if (currentIndex > 0) {
       activeTab.value = validTabs.value[currentIndex - 1].id
     }
   }
   ```

6. **Update v-window with touch prop:**
   ```vue
   <v-window v-model="activeTab" :touch="{ left: nextTab, right: prevTab }">
   ```

7. **Ensure icons display correctly:**
   - v-icon with `:icon="tab.icon"` and `start` attribute already in template
   - No changes needed if Task 1 from Plan 01 was correct
  </action>
  <verify>
Run: `cd /home/bernt-popp/development/gene-curator/frontend && npm run lint -- --fix && npm run build`
Confirm: No lint errors, build succeeds
  </verify>
  <done>DynamicForm.vue shows score badges on tabs with show_score_badge:true, badges update reactively, swipe gestures work on mobile</done>
</task>

<task type="auto">
  <name>Task 2: Add Test Coverage for Tabs and Sections</name>
  <files>
    frontend/src/components/dynamic/__tests__/DynamicForm.tabs.spec.js
    frontend/src/components/dynamic/__tests__/TabContent.spec.js
  </files>
  <action>
Create comprehensive test coverage following project patterns from Phase 1 tests.

**File 1: DynamicForm.tabs.spec.js**

1. **Test setup pattern (from 01-02 decisions):**
   - Stub all Vuetify components to avoid VProgressLinear matchMedia issues
   - Mock useLogger with vi.fn() for all methods
   - Mock useValidationStore with loading, error, getJsonSchema, getValidationResult

2. **Test cases for tab rendering:**
   ```javascript
   describe('DynamicForm Tab Rendering', () => {
     it('renders v-tabs when ui_configuration.layout.tabs is present', async () => {
       // Mount with schema containing valid tabs
       // Assert v-tabs rendered with correct number of v-tab children
     })

     it('renders flat field list when ui_configuration is absent', async () => {
       // Mount with schema without ui_configuration
       // Assert no v-tabs, DynamicField components rendered directly
     })

     it('renders flat field list when layout.type is not tabs', async () => {
       // Mount with ui_configuration.layout.type = 'grid'
       // Assert fallback to flat rendering
     })

     it('renders flat field list when tabs array is empty', async () => {
       // Mount with ui_configuration.layout.tabs = []
       // Assert fallback to flat rendering
     })

     it('filters out invalid tabs missing id or name', async () => {
       // Mount with some tabs missing id/name
       // Assert only valid tabs rendered
     })

     it('filters out tabs with no sections', async () => {
       // Mount with tab having empty sections array
       // Assert tab not rendered
     })

     it('falls back to flat when fewer than 2 valid tabs', async () => {
       // Mount with only 1 valid tab after filtering
       // Assert flat rendering (tabs not useful with single tab)
     })
   })
   ```

3. **Test cases for score badges:**
   ```javascript
   describe('Tab Score Badges', () => {
     it('displays score badge when tab.show_score_badge is true', async () => {
       // Mount with tab having show_score_badge: true
       // Mock validationResult with score_calculations
       // Assert v-chip visible with correct score
     })

     it('hides score badge when show_score_badge is false', async () => {
       // Mount with tab having show_score_badge: false
       // Assert no v-chip rendered for that tab
     })

     it('applies correct color based on score value', async () => {
       // Test score >= 7 -> success
       // Test score >= 2 -> warning
       // Test score < 2 -> info
       // Test undefined -> grey
     })
   })
   ```

4. **Test cases for tab navigation:**
   ```javascript
   describe('Tab Navigation', () => {
     it('initializes activeTab to first valid tab', async () => {
       // Mount and assert activeTab equals first tab.id
     })

     it('changes content when clicking different tab', async () => {
       // Simulate tab click
       // Assert v-window shows correct content
     })
   })
   ```

**File 2: TabContent.spec.js**

1. **Test setup similar to above**

2. **Test cases for section rendering:**
   ```javascript
   describe('TabContent Section Rendering', () => {
     it('renders v-expansion-panels with multiple prop', async () => {
       // Assert expansion panels allow multiple open
     })

     it('renders section names in panel titles', async () => {
       // Assert each section.name visible in panel title
     })

     it('renders section icon when present', async () => {
       // Assert v-icon with section.icon rendered
     })

     it('renders help_text as caption when present', async () => {
       // Assert help text visible in panel text
     })

     it('renders DynamicField for each field in section.fields', async () => {
       // Assert correct number of DynamicField components
       // Assert field-name prop matches field path
     })
   })
   ```

3. **Test cases for section collapsibility:**
   ```javascript
   describe('Section Collapsibility', () => {
     it('sections with collapsed: true start closed', async () => {
       // Assert panel not in openSections
     })

     it('sections with collapsed: false start open', async () => {
       // Assert panel index in openSections
     })

     it('sections without collapsed property start open', async () => {
       // Assert default is expanded
     })
   })
   ```

4. **Test cases for field path resolution:**
   ```javascript
   describe('Field Path Resolution', () => {
     it('resolves simple field paths', async () => {
       // Test getFieldValue('summary') returns formData.summary
     })

     it('resolves nested field paths', async () => {
       // Test getFieldValue('genetic_evidence.case_level') returns nested value
     })

     it('emits update:field with correct path and value', async () => {
       // Trigger field update
       // Assert emit called with (fieldPath, newValue)
     })
   })
   ```

**Pattern from Phase 1:** Use shallow: true to avoid mounting child components deeply, stub Vuetify components globally, structure tests with clear describe/it blocks.
  </action>
  <verify>
Run: `cd /home/bernt-popp/development/gene-curator/frontend && npm run test -- --run src/components/dynamic/__tests__/DynamicForm.tabs.spec.js src/components/dynamic/__tests__/TabContent.spec.js`
Confirm: All tests pass
  </verify>
  <done>Test files exist with comprehensive coverage for tab rendering, score badges, section collapsibility, and fallback behavior</done>
</task>

</tasks>

<verification>
1. **Lint passes:** `cd frontend && npm run lint` shows no errors
2. **Build succeeds:** `cd frontend && npm run build` completes without errors
3. **Tests pass:** `cd frontend && npm run test -- --run src/components/dynamic/__tests__/DynamicForm.tabs.spec.js src/components/dynamic/__tests__/TabContent.spec.js` all green
4. **Score badge present:** grep for `v-chip` and `tabScores` in DynamicForm.vue
5. **Touch prop present:** grep for `:touch=` in DynamicForm.vue
</verification>

<success_criteria>
- Score badges appear on tabs with show_score_badge: true
- Score badges show correct color based on score value
- Mobile swipe gestures navigate between tabs
- DynamicForm.tabs.spec.js covers tab rendering, fallback, and badges
- TabContent.spec.js covers section rendering, collapsibility, and field paths
- All tests pass
- Lint and build pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-tab-structure/02-02-SUMMARY.md`
</output>
