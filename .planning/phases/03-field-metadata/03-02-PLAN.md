---
phase: 03-field-metadata
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - frontend/src/components/dynamic/__tests__/DynamicField.spec.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Tests verify icon renders when icon property defined"
    - "Tests verify default icon when tooltip exists without icon"
    - "Tests verify tooltip appears on icon hover"
    - "Tests verify persistent hint renders below field"
    - "Tests verify hint truncation with show more/less toggle"
    - "Tests verify help icon click opens URL in new tab"
    - "Tests verify graceful rendering when metadata absent"
  artifacts:
    - path: "frontend/src/components/dynamic/__tests__/DynamicField.spec.js"
      provides: "Metadata feature test coverage"
      contains: ["describe.*metadata", "hasIcon", "hasTooltip", "hasHelpUrl", "hintExpanded"]
      min_lines: 800
  key_links:
    - from: "DynamicField.spec.js metadata tests"
      to: "DynamicField.vue"
      via: "mount/shallowMount with fieldSchema props containing icon/tooltip/hint/helpUrl"
      pattern: "fieldSchema.*icon.*tooltip.*hint.*helpUrl"
---

<objective>
Add comprehensive test coverage for field metadata features in DynamicField.

Purpose: Ensure metadata rendering (icons, hints, tooltips, help links) works correctly and prevents regressions.

Output: Extended DynamicField.spec.js with metadata-specific test suites covering all META-01 through META-05 requirements.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-field-metadata/03-01-SUMMARY.md
@.planning/phases/01-field-rendering/01-02-SUMMARY.md
@frontend/src/components/dynamic/__tests__/DynamicField.spec.js
@frontend/src/components/dynamic/DynamicField.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add icon and tooltip tests</name>
  <files>frontend/src/components/dynamic/__tests__/DynamicField.spec.js</files>
  <action>
Add a new describe block for metadata icon and tooltip tests. Follow the existing test patterns (mocking useLogger, stubbing Vuetify components).

1. **Update vuetifyStubs to include v-tooltip:**
   ```javascript
   'v-tooltip': {
     name: 'VTooltip',
     template: '<div class="v-tooltip" :class="{ disabled: disabled }"><slot name="activator" :props="{ class: \'tooltip-activator\' }"></slot><span class="v-tooltip-content"><slot></slot></span></div>',
     props: ['location', 'openDelay', 'disabled', 'text']
   }
   ```

2. **Add describe block for icons and tooltips** (after existing test suites):
   ```javascript
   describe('Field Metadata - Icons and Tooltips', () => {
     it('renders icon when icon property is defined', () => {
       const wrapper = mountComponent({
         fieldName: 'test_field',
         fieldSchema: {
           type: 'string',
           title: 'Test Field',
           icon: 'mdi-account'
         },
         modelValue: ''
       })

       // Icon should be rendered in prepend-inner
       expect(wrapper.html()).toContain('mdi-account')
     })

     it('renders default icon when tooltip defined but no icon', () => {
       const wrapper = mountComponent({
         fieldName: 'test_field',
         fieldSchema: {
           type: 'string',
           title: 'Test Field',
           tooltip: 'This is a tooltip'
         },
         modelValue: ''
       })

       // Default icon should appear
       expect(wrapper.html()).toContain('mdi-information-outline')
     })

     it('does not render icon when no icon or tooltip defined', () => {
       const wrapper = mountComponent({
         fieldName: 'test_field',
         fieldSchema: {
           type: 'string',
           title: 'Test Field'
         },
         modelValue: ''
       })

       // No icons in prepend area
       expect(wrapper.html()).not.toContain('mdi-information-outline')
       expect(wrapper.html()).not.toContain('mdi-account')
     })

     it('renders v-tooltip around icon when tooltip defined', () => {
       const wrapper = mountComponent({
         fieldName: 'test_field',
         fieldSchema: {
           type: 'string',
           title: 'Test Field',
           icon: 'mdi-account',
           tooltip: 'This is helpful context'
         },
         modelValue: ''
       })

       // Tooltip component should be present
       expect(wrapper.find('.v-tooltip').exists()).toBe(true)
       expect(wrapper.html()).toContain('This is helpful context')
     })

     it('disables tooltip when no tooltip text provided', () => {
       const wrapper = mountComponent({
         fieldName: 'test_field',
         fieldSchema: {
           type: 'string',
           title: 'Test Field',
           icon: 'mdi-account'
           // No tooltip property
         },
         modelValue: ''
       })

       // Tooltip should be disabled
       const tooltip = wrapper.find('.v-tooltip')
       if (tooltip.exists()) {
         expect(tooltip.classes()).toContain('disabled')
       }
     })

     it('uses grey-darken-1 color for icon accessibility', () => {
       const wrapper = mountComponent({
         fieldName: 'test_field',
         fieldSchema: {
           type: 'string',
           title: 'Test Field',
           icon: 'mdi-account'
         },
         modelValue: ''
       })

       // Icon should have correct color attribute
       expect(wrapper.html()).toContain('grey-darken-1')
     })
   })
   ```
  </action>
  <verify>Run `cd /home/bernt-popp/development/gene-curator/frontend && npm run test -- --run DynamicField` - all icon/tooltip tests pass.</verify>
  <done>6 new tests for icon rendering, default icon behavior, conditional rendering, tooltip wrapping, tooltip disabled state, and icon color.</done>
</task>

<task type="auto">
  <name>Task 2: Add hint and truncation tests</name>
  <files>frontend/src/components/dynamic/__tests__/DynamicField.spec.js</files>
  <action>
Add a new describe block for hint tests:

```javascript
describe('Field Metadata - Hints', () => {
  it('renders persistent hint when hint property defined', () => {
    const wrapper = mountComponent({
      fieldName: 'test_field',
      fieldSchema: {
        type: 'string',
        title: 'Test Field',
        hint: 'This is a helpful hint'
      },
      modelValue: ''
    })

    // Hint should be in the output
    expect(wrapper.html()).toContain('This is a helpful hint')
  })

  it('does not render hint when hint property absent', () => {
    const wrapper = mountComponent({
      fieldName: 'test_field',
      fieldSchema: {
        type: 'string',
        title: 'Test Field'
      },
      modelValue: ''
    })

    // No hint messages div
    const messagesDiv = wrapper.find('.v-messages')
    expect(messagesDiv.exists()).toBe(false)
  })

  it('truncates long hints over 100 characters', () => {
    const longHint = 'A'.repeat(150)
    const wrapper = mountComponent({
      fieldName: 'test_field',
      fieldSchema: {
        type: 'string',
        title: 'Test Field',
        hint: longHint
      },
      modelValue: ''
    })

    // Check that truncated text is rendered
    expect(wrapper.text()).toContain('A'.repeat(100) + '...')
    expect(wrapper.text()).toContain('show more')
  })

  it('expands truncated hint when show more clicked', async () => {
    const longHint = 'A'.repeat(150)
    const wrapper = mountComponent({
      fieldName: 'test_field',
      fieldSchema: {
        type: 'string',
        title: 'Test Field',
        hint: longHint
      },
      modelValue: ''
    })

    // Click show more
    const showMoreLink = wrapper.find('a.text-primary')
    expect(showMoreLink.exists()).toBe(true)
    await showMoreLink.trigger('click')

    // Full hint should now be visible
    expect(wrapper.text()).toContain(longHint)
    expect(wrapper.text()).toContain('show less')
  })

  it('collapses expanded hint when show less clicked', async () => {
    const longHint = 'A'.repeat(150)
    const wrapper = mountComponent({
      fieldName: 'test_field',
      fieldSchema: {
        type: 'string',
        title: 'Test Field',
        hint: longHint
      },
      modelValue: ''
    })

    // Expand first
    let link = wrapper.find('a.text-primary')
    await link.trigger('click')

    // Now collapse
    link = wrapper.find('a.text-primary')
    await link.trigger('click')

    // Should be truncated again
    expect(wrapper.text()).toContain('A'.repeat(100) + '...')
    expect(wrapper.text()).toContain('show more')
  })

  it('does not truncate hints under 100 characters', () => {
    const shortHint = 'A'.repeat(50)
    const wrapper = mountComponent({
      fieldName: 'test_field',
      fieldSchema: {
        type: 'string',
        title: 'Test Field',
        hint: shortHint
      },
      modelValue: ''
    })

    expect(wrapper.text()).toContain(shortHint)
    expect(wrapper.text()).not.toContain('show more')
  })

  it('handles exactly 100 character hint without truncation', () => {
    const exactHint = 'A'.repeat(100)
    const wrapper = mountComponent({
      fieldName: 'test_field',
      fieldSchema: {
        type: 'string',
        title: 'Test Field',
        hint: exactHint
      },
      modelValue: ''
    })

    expect(wrapper.text()).toContain(exactHint)
    expect(wrapper.text()).not.toContain('show more')
  })
})
```
  </action>
  <verify>Run `cd /home/bernt-popp/development/gene-curator/frontend && npm run test -- --run DynamicField` - all hint tests pass.</verify>
  <done>7 new tests for hint rendering, persistent hints, truncation, expand/collapse toggle, short hint behavior, and boundary case (exactly 100 chars).</done>
</task>

<task type="auto">
  <name>Task 3: Add help URL tests and combined metadata tests</name>
  <files>frontend/src/components/dynamic/__tests__/DynamicField.spec.js</files>
  <action>
Add describe blocks for help URL tests and combined metadata scenarios:

```javascript
describe('Field Metadata - Help Links', () => {
  it('renders help icon when helpUrl property defined', () => {
    const wrapper = mountComponent({
      fieldName: 'test_field',
      fieldSchema: {
        type: 'string',
        title: 'Test Field',
        helpUrl: 'https://docs.example.com/help'
      },
      modelValue: ''
    })

    expect(wrapper.html()).toContain('mdi-help-circle-outline')
  })

  it('does not render help icon when helpUrl absent', () => {
    const wrapper = mountComponent({
      fieldName: 'test_field',
      fieldSchema: {
        type: 'string',
        title: 'Test Field'
      },
      modelValue: ''
    })

    expect(wrapper.html()).not.toContain('mdi-help-circle-outline')
  })

  it('opens help URL in new tab when help icon clicked', async () => {
    const mockOpen = vi.spyOn(window, 'open').mockImplementation(() => null)

    const wrapper = mountComponent({
      fieldName: 'test_field',
      fieldSchema: {
        type: 'string',
        title: 'Test Field',
        helpUrl: 'https://docs.example.com/help'
      },
      modelValue: ''
    })

    // Find and click help icon
    const icons = wrapper.findAll('.v-icon')
    const helpIcon = icons.find(icon => icon.html().includes('mdi-help-circle-outline'))
    expect(helpIcon).toBeDefined()
    await helpIcon.trigger('click')

    expect(mockOpen).toHaveBeenCalledWith(
      'https://docs.example.com/help',
      '_blank',
      'noopener,noreferrer'
    )

    mockOpen.mockRestore()
  })

  it('does not render help icon for invalid URL (not http/https)', () => {
    const wrapper = mountComponent({
      fieldName: 'test_field',
      fieldSchema: {
        type: 'string',
        title: 'Test Field',
        helpUrl: 'not-a-url'
      },
      modelValue: ''
    })

    // Invalid URL should not render help icon
    expect(wrapper.html()).not.toContain('mdi-help-circle-outline')
  })

  it('accepts http URLs', () => {
    const wrapper = mountComponent({
      fieldName: 'test_field',
      fieldSchema: {
        type: 'string',
        title: 'Test Field',
        helpUrl: 'http://docs.example.com/help'
      },
      modelValue: ''
    })

    expect(wrapper.html()).toContain('mdi-help-circle-outline')
  })

  it('logs info when help URL opened', async () => {
    const mockOpen = vi.spyOn(window, 'open').mockImplementation(() => null)

    const wrapper = mountComponent({
      fieldName: 'test_field',
      fieldSchema: {
        type: 'string',
        title: 'Test Field',
        helpUrl: 'https://docs.example.com/help'
      },
      modelValue: ''
    })

    const icons = wrapper.findAll('.v-icon')
    const helpIcon = icons.find(icon => icon.html().includes('mdi-help-circle-outline'))
    await helpIcon.trigger('click')

    expect(mockLogger.info).toHaveBeenCalledWith(
      'Help documentation opened',
      expect.objectContaining({
        fieldName: 'test_field',
        helpUrl: 'https://docs.example.com/help'
      })
    )

    mockOpen.mockRestore()
  })
})

describe('Field Metadata - Combined Scenarios', () => {
  it('renders all metadata types together correctly', () => {
    const wrapper = mountComponent({
      fieldName: 'full_metadata_field',
      fieldSchema: {
        type: 'string',
        title: 'Full Metadata Field',
        icon: 'mdi-star',
        tooltip: 'Star tooltip',
        hint: 'This is a hint',
        helpUrl: 'https://example.com/help'
      },
      modelValue: ''
    })

    // Icon present
    expect(wrapper.html()).toContain('mdi-star')

    // Tooltip content present
    expect(wrapper.html()).toContain('Star tooltip')

    // Help icon present
    expect(wrapper.html()).toContain('mdi-help-circle-outline')

    // Hint present
    expect(wrapper.text()).toContain('This is a hint')
  })

  it('renders field correctly with no metadata', () => {
    const wrapper = mountComponent({
      fieldName: 'plain_field',
      fieldSchema: {
        type: 'string',
        title: 'Plain Field'
      },
      modelValue: ''
    })

    // Field renders without errors
    expect(wrapper.exists()).toBe(true)
    expect(wrapper.find('.v-text-field').exists()).toBe(true)

    // No metadata elements
    expect(wrapper.html()).not.toContain('mdi-help-circle-outline')
    expect(wrapper.html()).not.toContain('mdi-information-outline')
  })

  it('renders metadata correctly for select field type', () => {
    const wrapper = mountComponent({
      fieldName: 'select_field',
      fieldSchema: {
        type: 'string',
        title: 'Select Field',
        enum: ['option1', 'option2'],
        icon: 'mdi-format-list-bulleted',
        hint: 'Select an option',
        helpUrl: 'https://example.com/help'
      },
      modelValue: ''
    })

    expect(wrapper.html()).toContain('mdi-format-list-bulleted')
    expect(wrapper.text()).toContain('Select an option')
    expect(wrapper.html()).toContain('mdi-help-circle-outline')
  })

  it('renders metadata correctly for number field type', () => {
    const wrapper = mountComponent({
      fieldName: 'number_field',
      fieldSchema: {
        type: 'number',
        title: 'Number Field',
        icon: 'mdi-numeric',
        hint: 'Enter a number',
        tooltip: 'Must be between 0 and 100'
      },
      modelValue: 0
    })

    expect(wrapper.html()).toContain('mdi-numeric')
    expect(wrapper.text()).toContain('Enter a number')
    expect(wrapper.html()).toContain('Must be between 0 and 100')
  })

  it('renders metadata correctly for textarea field type', () => {
    const wrapper = mountComponent({
      fieldName: 'textarea_field',
      fieldSchema: {
        type: 'string',
        title: 'Textarea Field',
        multiline: true,
        icon: 'mdi-text-box',
        hint: 'Enter detailed notes',
        helpUrl: 'https://example.com/notes-help'
      },
      modelValue: ''
    })

    expect(wrapper.html()).toContain('mdi-text-box')
    expect(wrapper.text()).toContain('Enter detailed notes')
    expect(wrapper.html()).toContain('mdi-help-circle-outline')
  })

  it('shows description when hint not provided (backward compatibility)', () => {
    const wrapper = mountComponent({
      fieldName: 'legacy_field',
      fieldSchema: {
        type: 'string',
        title: 'Legacy Field',
        description: 'This is a legacy description'
      },
      modelValue: ''
    })

    expect(wrapper.text()).toContain('This is a legacy description')
  })

  it('hides description when hint is provided', () => {
    const wrapper = mountComponent({
      fieldName: 'modern_field',
      fieldSchema: {
        type: 'string',
        title: 'Modern Field',
        description: 'Legacy description',
        hint: 'Modern hint'
      },
      modelValue: ''
    })

    expect(wrapper.text()).toContain('Modern hint')
    expect(wrapper.text()).not.toContain('Legacy description')
  })
})
```

After adding all tests, run the full test suite to ensure everything passes.
  </action>
  <verify>
Run: `cd /home/bernt-popp/development/gene-curator/frontend && npm run test -- --run DynamicField`
Confirm: All tests pass (existing + new metadata tests)
  </verify>
  <done>13 new tests for help URL rendering, click behavior, URL validation, logging, combined metadata scenarios for different field types, and backward compatibility with description property. Full test suite passes.</done>
</task>

</tasks>

<verification>
1. **All tests pass:** `cd frontend && npm run test -- --run DynamicField` - all tests pass
2. **Lint passes:** `cd frontend && npm run lint` - no lint errors in test files
3. **Test count increase:** Approximately 26 new test cases added (6 + 7 + 13)
4. **Coverage check:** Test output shows metadata describe blocks running
5. **No regressions:** Existing tests continue to pass
</verification>

<success_criteria>
- New describe blocks: 'Field Metadata - Icons and Tooltips', 'Field Metadata - Hints', 'Field Metadata - Help Links', 'Field Metadata - Combined Scenarios'
- Approximately 26 new test cases covering all META-01 through META-05 requirements
- Tests cover icon rendering (with/without tooltip), default icon behavior, icon color accessibility
- Tests cover hint rendering, truncation at 100 chars, show more/less toggle functionality
- Tests cover help URL rendering, click opens new tab with security attributes, URL validation
- Tests cover combined metadata scenarios and different field types (string, select, number, textarea)
- Tests cover backward compatibility with description property
- window.open properly mocked and restored in help URL tests
- All existing tests continue to pass (no regressions)
- Lint passes on test file
</success_criteria>

<output>
After completion, create `.planning/phases/03-field-metadata/03-02-SUMMARY.md`
</output>
